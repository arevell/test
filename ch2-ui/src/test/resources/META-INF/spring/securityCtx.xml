<beans:beans xmlns="http://www.springframework.org/schema/security"
  xmlns:beans="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:jdbc="http://www.springframework.org/schema/jdbc"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
           http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.1.xsd
           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd
           http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd"
           >
           
	<global-method-security secured-annotations="enabled" authentication-manager-ref="ch2AuthenticationManager" pre-post-annotations="enabled">
		<!-- AspectJ pointcut expression that locates our "post" method and applies security that way
		<protect-pointcut expression="execution(* bigbank.*Service.post*(..))" access="ROLE_TELLER"/>
		-->
	</global-method-security>
		
	<authentication-manager id="ch2AuthenticationManager" alias="ch2AuthenticationManager">	
		<authentication-provider ref="tokenProvider" />
		<authentication-provider ref="guiProvider" />
<!-- 		<authentication-provider ref="noMd5Provider" /> -->
		<authentication-provider ref="ldapAuthenticationProvider" />
	</authentication-manager>
	

   <beans:bean id="loggerListener" class="org.springframework.security.access.event.LoggerListener" />
   <beans:bean id="loginHandler"  name="loginHandler" class="com.ttc.ch2.ui.moduls.auth.LoginHandler"/>   
   <beans:bean id="logoutHandler"  name="logoutHandler" class="com.ttc.ch2.ui.moduls.auth.LogoutHandler">
  		<beans:property name="urlLogoutSucces" value="/modules/auth/logout_success.zul"/>
   </beans:bean>
   
   <beans:bean id="loginFailHandler" class="com.ttc.ch2.ui.moduls.auth.LoginFailHandler">
    <beans:property name="exceptionMappings">
        <beans:props>
        	<beans:prop key="org.springframework.security.authentication.BadCredentialsException">/modules/auth/login.zul?error=1</beans:prop>
        	<beans:prop key="org.springframework.security.core.userdetails.UsernameNotFoundException">/modules/auth/login.zul?error=2</beans:prop>
        	<beans:prop key="org.springframework.security.core.AuthenticationException">/modules/auth/login.zul?error=3</beans:prop>
        	<beans:prop key="org.springframework.security.access.AccessDeniedException">/modules/auth/login.zul?error=4</beans:prop>        	        	            	        
        </beans:props>  
    </beans:property>
   </beans:bean>
   
   <http pattern="/css/**" security="none" />
   <http pattern="/img/**" security="none" />
   <http pattern="/base/**" security="none" />
   <http pattern="/zkau/**js**" security="none" />
   <!-- <http pattern="/zkau/**img**" security="none" />
   <http pattern="/zkau/**css**" security="none" /> -->
   <http pattern="/zkau/web**" security="none" />
   <http pattern="/modules/auth/login.zul**" security="none" />
   
   
	<http auto-config="false" entry-point-ref="tokenAuthenticationEntryPoint" pattern="/tour_departure/**" authentication-manager-ref="ch2AuthenticationManager">		
		<intercept-url pattern="/tour_departure/**" access="ROLE_CCAPI"/> 
		<intercept-url pattern="/tour_departure/**.xml*" access="ROLE_CCAPI"/> 
		<custom-filter position="PRE_AUTH_FILTER" ref="tokenPreAuthenticatedProcessingFilter" />
		<custom-filter position="LAST" ref="redirectFilter" />		
	</http>
		

 	<http auto-config="false" entry-point-ref="tokenAuthenticationEntryPoint" pattern="/tour_info/**" authentication-manager-ref="ch2AuthenticationManager">		
		<intercept-url pattern="/tour_info/**" access="ROLE_CCAPI"/> 
		<intercept-url pattern="/tour_info/**.xml*" access="ROLE_CCAPI"/> 
		<custom-filter position="PRE_AUTH_FILTER" ref="tokenPreAuthenticatedProcessingFilter" />
		<custom-filter position="LAST" ref="redirectFilter" />		
	</http>
 
	<http auto-config="false" entry-point-ref="tokenAuthenticationEntryPoint" pattern="/outgoing_archives/**" authentication-manager-ref="ch2AuthenticationManager">
		<intercept-url pattern="/outgoing_archives/**" access="ROLE_CCAPI"/>		
		<custom-filter position="PRE_AUTH_FILTER" ref="tokenPreAuthenticatedProcessingFilter" />
		<custom-filter position="LAST" ref="redirectFilter" />
	</http>

	<http auto-config="false" entry-point-ref="tokenAuthenticationEntryPoint" pattern="/brochure_engine/**" authentication-manager-ref="ch2AuthenticationManager">
		<intercept-url pattern="/brochure_engine/**" access="ROLE_CCAPI"/>
		<custom-filter position="PRE_AUTH_FILTER" ref="tokenPreAuthenticatedProcessingFilter" />
		<custom-filter position="LAST" ref="redirectFilter" />
	</http> 


   <!-- <http pattern="/modules/auth/**" security="none" />-->
   
   
	   
   
	<!-- <http auto-config='true'>-->     	
	
	<http auto-config='true' authentication-manager-ref="ch2AuthenticationManager" use-expressions="true"  >     	
	   	<!-- <intercept-url pattern="/modules/auth/login.zul*" requires-channel="https"/> -->   	    		  	
	  	<intercept-url pattern="/modules/auth/logout_success.zul" access="permitAll"/> 
	  	<intercept-url pattern="/modules/auth/**" access="permitAll"/>  		  	 		  	 
	  	<intercept-url pattern="/common/**" access="hasAnyRole('ROLE_BRAND','ROLE_ADMIN')"/>
	  	<intercept-url pattern="/modules/tour/**" access="hasRole('ROLE_BRAND')"/>
	  	<!-- <intercept-url pattern="/modules/brochure/**" access="hasRole('ROLE_BRAND')" /> -->
	  	<intercept-url pattern="/modules/messages/**" access="hasAnyRole('ROLE_BRAND','ROLE_ADMIN')" />  		  	 
	  	<intercept-url pattern="/modules/audit/**" access="hasRole('ROLE_ADMIN')" />  
	  	<intercept-url pattern="/modules/jobs/**" access="hasRole('ROLE_ADMIN')" />  
	  	<intercept-url pattern="/modules/users/**" access="hasRole('ROLE_ADMIN')" />
	  	  	  	
	  	<intercept-url pattern="/zkau/view**" access="isAuthenticated()"/>   
	  	<!-- <intercept-url pattern="/zkau/**" access="isAuthenticated()"/> -->   
	  	<!-- 
	  	<session-management session-fixation-protection="newSession" 
	  	session-authentication-error-url="/base/error.zul" 
	  	invalid-session-url="/base/invalid_session.zul" >
	  		<concurrency-control max-sessions="1" />
	  	</session-management>-->
	  	
	  	<session-management session-fixation-protection="newSession" session-authentication-error-url="/base/error.zul">	
	  		<concurrency-control max-sessions="1" />
	  	</session-management>
	  	
	  	<!-- default-target-url="/modules/tour/upload_tour_info.zul"  always-use-default-target="true"-->
	    <form-login login-page='/modules/auth/login.zul' 	       
	    authentication-success-handler-ref="loginHandler"
	    authentication-failure-handler-ref="loginFailHandler"   
	    login-processing-url="/modules/auth/j_security_check" />
    	<!-- <logout invalidate-session="true" logout-success-url="/modules/auth/logout_success.zul" logout-url="/modules/auth/j_spring_security_logout" delete-cookies="JSESSIONID"/>-->    	
    	<logout  invalidate-session="false" delete-cookies="JSESSIONID"  success-handler-ref="logoutHandler"  logout-url="/modules/auth/j_spring_security_logout"/>
    	<access-denied-handler error-page="/modules/auth/access_denied.zul"/>    	
	    <!-- <logout  invalidate-session="false" logout-success-url="/modules/auth/logout_success.zul"  logout-url="/modules/auth/j_spring_security_logout"/> -->    	
	</http>
	
	
	
	<beans:bean id="tokenAuthenticationEntryPoint"  class="com.ttc.ch2.ui.common.security.TokenAuthenticationEntryPoint"/>
		
	<beans:bean id="tokenPreAuthenticatedProcessingFilter" class="com.ttc.ch2.ui.common.security.TokenPreAuthenticatedProcessingFilter">
    	 <beans:property name="authenticationManager" ref="ch2AuthenticationManager" />
	</beans:bean>
		
 	<beans:bean id="tokenProvider" class="com.ttc.ch2.ui.common.security.TokenAuthenticationProvider" />
 	<beans:bean id="guiProvider" class="com.ttc.ch2.ui.common.security.GuiAuthenticationProvider" />
 	<beans:bean id="noMd5Provider" class="com.ttc.ch2.ui.common.security.NoMd5AuthenticationProvider" />
 	<beans:bean id="ldapAuthenticationProvider" class="com.ttc.ch2.ui.common.security.LdapAuthenticationProvider">
		<beans:constructor-arg value="${ad.domain}" />
		<beans:constructor-arg value="${ad.url}" />
		<beans:property name="convertSubErrorCodesToExceptions"	value="true" />
		<!-- <beans:property name="authoritiesMapper" ref="LdapAuthoritiesMapper" /> -->
		<beans:property name="userDetailsContextMapper" ref="ChLdapUserDetailsMapper" />
	</beans:bean>
	<!-- <beans:bean id="LdapAuthoritiesMapper" class="com.ttc.ch2.ui.common.security.LdapAuthoritiesMapper" /> -->
	<beans:bean id="ChLdapUserDetailsMapper" class="com.ttc.ch2.ui.common.security.ChLdapUserDetailsMapper" />
 	
 	<beans:bean id="redirectFilter" class="com.ttc.ch2.ui.common.security.AfterLoginRedirect"/> 
 	 		
	<beans:bean id="accessDecisionManager" class="org.springframework.security.access.vote.AffirmativeBased">
		<beans:property name="decisionVoters">
			<beans:list>
				 <beans:bean class="com.ttc.ch2.ui.common.security.ZkauVoter" />
			</beans:list>
		</beans:property>
	</beans:bean>
		
</beans:beans>